{"version":3,"sources":["file:///E:/cocos/cocos-awesome-tech-solutions/demo/Creator3.6.0_Raphael/assets/start-scene/scripts/Global/SceneList.ts"],"names":["_decorator","Component","Prefab","ScrollView","instantiate","Vec3","path","assetManager","UITransform","Size","ListItem","ccclass","property","SceneList","menu","sceneList","itemList","updateTimer","updateInterval","lastContentPosY","createItem","x","y","name","url","item","itemPrefab","itemComp","getComponent","label","string","setPosition","node","addChild","init","initList","scenes","main","config","forEach","val","push","dict","i","j","length","dirname","replace","scenename","basename","console","log","dirs","Object","keys","sort","scenenames","com","setContentSize","width","initItemCount","itemInfo","updateItem","getPositionInView","worldPos","parent","convertToWorldSpaceAR","position","viewPos","scrollView","convertToNodeSpaceAR","update","dt","items","buffer","bufferZone","isDown","curItemCount","offset","itemNode","newIdx","index","newInfo","height"],"mappings":"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","sourcesContent":["import { _decorator, Component, Prefab, ScrollView, instantiate, Vec2, Vec3, game, path, assetManager, UITransform, Size } from 'cc';\r\nimport { ListItem } from './ListItem';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('SceneList')\r\nexport class SceneList extends Component {\r\n    @property(Prefab)\r\n    public itemPrefab: Prefab = null;\r\n    @property\r\n    public initItemCount = 0;\r\n    @property(ScrollView)\r\n    public scrollView: ScrollView | null = null;\r\n    @property\r\n    public bufferZone = 0;\r\n    menu = null;\r\n    sceneList = [];\r\n    itemList = [];\r\n    updateTimer = 0;\r\n    updateInterval = 0.2;\r\n    lastContentPosY = 0;\r\n    createItem(x: any, y: any, name: any, url: any) {\r\n        var item = instantiate(this.itemPrefab);\r\n        var itemComp = item.getComponent(ListItem);\r\n        var label = itemComp.label;\r\n        label.string = name;\r\n        if (url) {\r\n            itemComp.url = url;\r\n        }\r\n        item.setPosition(new Vec3(x, y, 0));\r\n\r\n        this.node.addChild(item);\r\n        return item;\r\n    }\r\n\r\n    init(menu: any) {\r\n        this.menu = menu;\r\n        this.sceneList = [];\r\n        this.itemList = [];\r\n        this.updateTimer = 0;\r\n        this.updateInterval = 0.2;\r\n        this.lastContentPosY = 0; // use this variable to detect if we are scrolling up or down\r\n        this.initList();\r\n    }\r\n\r\n    initList() {\r\n        // var scenes = game._sceneInfos; //is deprecated\r\n        let scenes = [];\r\n        if (assetManager.main) {\r\n            assetManager.main.config.scenes.forEach((val) => {\r\n                scenes.push(val);\r\n            });\r\n        }\r\n        var dict = {};\r\n        if (scenes) {\r\n            var i, j;\r\n            for (i = 0; i < scenes.length; ++i) {\r\n                let url = scenes[i].url;\r\n                let dirname = path.dirname(url).replace('db://assets/cases/', '');\r\n                if (dirname === 'db://assets/resources/test assets') {\r\n                    continue;\r\n                }\r\n                let scenename = path.basename(url, '.fire');\r\n                if (scenename === 'TestList') continue;\r\n                if (!dirname) dirname = '_root';\r\n                if (!dict[dirname]) {\r\n                    dict[dirname] = {};\r\n                }\r\n                dict[dirname][scenename] = url;\r\n            }\r\n        } else {\r\n            console.log('failed to get scene list!');\r\n        }\r\n        let dirs = Object.keys(dict);\r\n        dirs.sort();\r\n        for (let i = 0; i < dirs.length; ++i) {\r\n            this.sceneList.push({\r\n                name: dirs[i],\r\n                url: null\r\n            });\r\n            let scenenames = Object.keys(dict[dirs[i]]);\r\n            scenenames.sort();\r\n            for (let j = 0; j < scenenames.length; ++j) {\r\n                let name = scenenames[j];\r\n                this.sceneList.push({\r\n                    name: name,\r\n                    url: dict[dirs[i]][name]\r\n                });\r\n            }\r\n        }\r\n        let y = 0;\r\n        let com = this.node.getComponent(UITransform);\r\n        com.setContentSize(new Size(com.width,(this.sceneList.length + 1) * 50))\r\n        for (let i = 0; i < this.initItemCount; ++i) {\r\n            let item = instantiate(this.itemPrefab).getComponent(ListItem);\r\n            let itemInfo = this.sceneList[i];\r\n            item.init(this.menu);\r\n            this.node.addChild(item.node);\r\n            y -= 50;\r\n            item.updateItem(i, y, itemInfo.name, itemInfo.url);\r\n            this.itemList.push(item);\r\n        }\r\n    }\r\n\r\n    getPositionInView(item: any) {\r\n        let worldPos = item.parent.getComponent(UITransform).convertToWorldSpaceAR(item.position);\r\n        let viewPos = this.scrollView.node.getComponent(UITransform).convertToNodeSpaceAR(worldPos);\r\n        return viewPos;\r\n    }\r\n\r\n    update(dt: any) {\r\n        this.updateTimer += dt;\r\n        if (this.updateTimer < this.updateInterval) {\r\n           return; // we don't need to do the math every frame\r\n        }\r\n        this.updateTimer = 0;\r\n        let items = this.itemList;\r\n        let buffer = this.bufferZone;\r\n        let isDown = this.node.position.y < this.lastContentPosY; // scrolling direction\r\n        let curItemCount = this.itemList.length;\r\n        let offset = 50 * curItemCount;\r\n        for (let i = 0; i < curItemCount; ++i) {\r\n           let item = items[i];\r\n           let itemNode = item.node;\r\n           let viewPos = this.getPositionInView(itemNode);\r\n           if (isDown) {\r\n               if (viewPos.y < -buffer && itemNode.y + offset < 0) {\r\n                   let newIdx = item.index - curItemCount;\r\n                   let newInfo = this.sceneList[newIdx];\r\n                   item.updateItem(newIdx, itemNode.y + offset, newInfo.name, newInfo.url );\r\n               }\r\n           } else {\r\n               if (viewPos.y > buffer && itemNode.y - offset > -this.node.getComponent(UITransform).height) {\r\n                   let newIdx = item.index + curItemCount;\r\n                   let newInfo = this.sceneList[newIdx];\r\n                   item.updateItem(newIdx, itemNode.y - offset, newInfo.name, newInfo.url);\r\n               }\r\n           }\r\n        }\r\n        this.lastContentPosY = this.node.position.y;\r\n    }\r\n\r\n}\r\n\r\n\r\n"]}